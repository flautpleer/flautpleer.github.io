<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlautПлеер - Ваша музыка</title>
    <meta name="description" content="FlautПлеер - персонализированный музыкальный плеер">
    <meta name="theme-color" content="#BC13FE">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Иконки для разных устройств -->
    <link rel="icon" href="/home/dertuff/Загрузки/иконка.png" type="image/png">
    <link rel="apple-touch-icon" href="/home/dertuff/Загрузки/иконка.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-purple: #BC13FE;
            --electric-pink: #FF44CC;
            --cyber-blue: #0FF0FC;
            --matrix-green: #00FF41;
            --deep-space: #0C0032;
            --cosmic-purple: #190028;
            --void-black: #000000;
            --stardust: #35004F;
            --galaxy-blue: #240046;
            --text-glow: #FFFFFF;
            --accent-gold: #FFD700;
            --neon-cyan: #00FFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--void-black), var(--deep-space), var(--cosmic-purple));
            color: var(--text-glow);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 5s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            z-index: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            animation: fadeInDown 1s ease;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, var(--neon-purple), var(--electric-pink));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite, rotate 10s linear infinite;
            box-shadow: 0 0 15px var(--neon-purple);
        }

        .logo-text {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(to right, var(--neon-purple), var(--electric-pink), var(--cyber-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(188, 19, 254, 0.5);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--neon-purple), var(--electric-pink));
            box-shadow: 0 0 15px rgba(188, 19, 254, 0.5);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(188, 19, 254, 0.7);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--neon-purple), var(--cyber-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            padding: 40px 0;
            animation: fadeIn 1.5s ease;
        }

        .player-container {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7), 
                        0 0 0 1px rgba(188, 19, 254, 0.3),
                        inset 0 0 20px rgba(188, 19, 254, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 30px;
        }

        .player-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.8), 
                        0 0 0 1px rgba(188, 19, 254, 0.5),
                        inset 0 0 30px rgba(188, 19, 254, 0.2);
        }

        .album-art {
            width: 280px;
            height: 280px;
            margin: 0 auto 30px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8), 0 0 20px rgba(188, 19, 254, 0.4);
            position: relative;
            background: linear-gradient(45deg, var(--stardust), var(--galaxy-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-glow);
            font-size: 50px;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .album-art:hover img {
            transform: scale(1.05);
        }

        .visualizer {
            display: flex;
            justify-content: center;
            gap: 3px;
            height: 50px;
            margin: 20px 0;
            align-items: flex-end;
        }

        .bar {
            width: 6px;
            background: linear-gradient(to top, var(--neon-purple), var(--electric-pink));
            border-radius: 3px;
            animation: equalizer 1.5s ease infinite;
            box-shadow: 0 0 10px var(--neon-purple);
        }

        .bar:nth-child(1) { animation-delay: 0.1s; height: 20px; }
        .bar:nth-child(2) { animation-delay: 0.2s; height: 30px; }
        .bar:nth-child(3) { animation-delay: 0.3s; height: 40px; }
        .bar:nth-child(4) { animation-delay: 0.4s; height: 50px; }
        .bar:nth-child(5) { animation-delay: 0.5s; height: 40px; }
        .bar:nth-child(6) { animation-delay: 0.6s; height: 30px; }
        .bar:nth-child(7) { animation-delay: 0.7s; height: 20px; }

        @keyframes equalizer {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }

        .song-info {
            text-align: center;
            margin-bottom: 25px;
        }

        .song-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-glow);
            text-shadow: 0 0 10px rgba(188, 19, 254, 0.7);
        }

        .song-artist {
            font-size: 18px;
            color: var(--cyber-blue);
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, var(--neon-purple), var(--electric-pink));
            border-radius: 4px;
            transition: width 0.1s;
            box-shadow: 0 0 10px var(--neon-purple);
            position: relative;
        }

        .progress::after {
            content: '';
            position: absolute;
            top: -2px;
            right: 0;
            width: 15px;
            height: 15px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--neon-purple);
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
            color: var(--cyber-blue);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-glow);
            font-size: 20px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--neon-purple);
        }

        .control-btn.active {
            background: rgba(188, 19, 254, 0.3);
            box-shadow: 0 0 15px var(--neon-purple);
        }

        .play-btn {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--neon-purple), var(--electric-pink));
            box-shadow: 0 5px 20px rgba(188, 19, 254, 0.7);
        }

        .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 7px 25px rgba(188, 19, 254, 0.9);
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .volume-slider {
            flex-grow: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--electric-pink);
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-purple);
        }

        .library-section {
            display: flex;
            gap: 30px;
            width: 100%;
            max-width: 1000px;
        }

        .upload-section, .playlist-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7), 
                        0 0 0 1px rgba(188, 19, 254, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--text-glow);
            text-shadow: 0 0 10px rgba(188, 19, 254, 0.7);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 2px dashed var(--neon-purple);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(188, 19, 254, 0.05);
        }

        .upload-area:hover {
            background: rgba(188, 19, 254, 0.1);
            border-color: var(--electric-pink);
        }

        .upload-icon {
            font-size: 50px;
            color: var(--neon-purple);
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .uploaded-files {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .uploaded-file-name {
            flex-grow: 1;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-remove {
            color: var(--electric-pink);
            cursor: pointer;
            margin-left: 10px;
        }

        .playlist {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .playlist::-webkit-scrollbar {
            width: 8px;
        }

        .playlist::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: var(--neon-purple);
            border-radius: 4px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
            border-left: 3px solid var(--neon-purple);
        }

        .playlist-item.active {
            background: linear-gradient(135deg, rgba(188, 19, 254, 0.2), rgba(255, 68, 204, 0.2));
            border-left: 3px solid var(--electric-pink);
        }

        .playlist-item img {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            margin-right: 15px;
            object-fit: cover;
        }

        .playlist-info {
            flex-grow: 1;
        }

        .playlist-song {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .playlist-artist {
            font-size: 12px;
            color: var(--cyber-blue);
        }

        .playlist-duration {
            color: var(--text-glow);
            font-size: 14px;
        }

        .playlist-actions {
            display: flex;
            gap: 10px;
            margin-left: 10px;
        }

        .playlist-action {
            color: var(--cyber-blue);
            cursor: pointer;
            transition: color 0.3s;
        }

        .playlist-action:hover {
            color: var(--electric-pink);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, var(--deep-space), var(--cosmic-purple));
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(188, 19, 254, 0.5);
            border: 1px solid var(--neon-purple);
            animation: modalAppear 0.5s ease;
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-glow);
            text-shadow: 0 0 10px rgba(188, 19, 254, 0.7);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--cyber-blue);
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--neon-purple);
            box-shadow: 0 0 10px rgba(188, 19, 254, 0.5);
        }

        .profile-modal {
            max-width: 500px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--neon-purple), var(--cyber-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: bold;
        }

        .profile-info h3 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .profile-info p {
            color: var(--cyber-blue);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--neon-purple);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--cyber-blue);
        }

        footer {
            text-align: center;
            padding: 20px 0;
            color: var(--text-dim);
            font-size: 14px;
            margin-top: auto;
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 15px var(--neon-purple); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px var(--neon-purple); }
            100% { transform: scale(1); box-shadow: 0 0 15px var(--neon-purple); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .library-section {
                flex-direction: column;
            }
            
            .logo-text {
                font-size: 24px;
            }
            
            .player-container {
                padding: 20px;
            }
            
            .album-art {
                width: 220px;
                height: 220px;
            }
        }

        @media (max-width: 480px) {
            .logo-text {
                font-size: 20px;
            }
            
            .album-art {
                width: 180px;
                height: 180px;
            }
            
            .song-title {
                font-size: 20px;
            }
            
            .control-btn {
                width: 45px;
                height: 45px;
            }
            
            .play-btn {
                width: 60px;
                height: 60px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--neon-purple);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--neon-purple);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-music"></i>
                </div>
                <div class="logo-text">FlautПлеер</div>
            </div>
            <div class="user-section">
                <div class="auth-buttons" id="authButtons">
                    <button class="btn" id="loginBtn">Войти</button>
                    <button class="btn btn-primary" id="registerBtn">Регистрация</button>
                </div>
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="avatar" id="userAvatar">U</div>
                    <span id="userName">Пользователь</span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="player-container">
                <div class="album-art" id="albumArt">
                    <i class="fas fa-music"></i>
                </div>
                
                <div class="visualizer" id="visualizer">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>
                
                <div class="song-info">
                    <h2 class="song-title" id="songTitle">Выберите трек</h2>
                    <p class="song-artist" id="songArtist">Ваш плейлист</p>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div class="time-info">
                        <span class="current-time" id="currentTime">0:00</span>
                        <span class="total-time" id="totalTime">0:00</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="control-btn shuffle-btn" id="shuffleBtn">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="control-btn prev-btn" id="prevBtn">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-btn" id="playBtn">
                        <i class="fas fa-play" id="playIcon"></i>
                    </button>
                    <button class="control-btn next-btn" id="nextBtn">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn repeat-btn" id="repeatBtn">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="volume-container">
                    <i class="fas fa-volume-up"></i>
                    <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
                </div>
            </div>

            <div class="library-section">
                <div class="upload-section">
                    <h3 class="section-title"><i class="fas fa-cloud-upload-alt"></i> Загрузить музыку</h3>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-file-audio"></i>
                        </div>
                        <p>Перетащите MP3 файлы сюда или нажмите для загрузки</p>
                        <input type="file" id="fileInput" class="file-input" accept=".mp3" multiple>
                    </div>
                    <div class="uploaded-files" id="uploadedFiles"></div>
                    <button class="btn btn-primary" id="uploadBtn" style="width: 100%;">
                        <i class="fas fa-upload"></i> Добавить в плейлист
                    </button>
                </div>
                
                <div class="playlist-section">
                    <h3 class="section-title"><i class="fas fa-list"></i> Ваш плейлист</h3>
                    <div class="playlist" id="playlist">
                        <div class="playlist-empty" id="playlistEmpty">
                            <p>Ваш плейлист пуст. Загрузите музыку чтобы начать слушать.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>FlautПлеер © 2023 | Слушайте свою музыку с удовольствием</p>
        </footer>
    </div>

    <!-- Модальные окна -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2 class="modal-title">Вход в аккаунт</h2>
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="Ваш email">
            </div>
            <div class="form-group">
                <label for="loginPassword">Пароль</label>
                <input type="password" id="loginPassword" placeholder="Ваш пароль">
            </div>
            <button class="btn btn-primary" id="loginSubmit" style="width: 100%;">Войти</button>
            <p style="text-align: center; margin-top: 15px;">
                Нет аккаунта? <a href="#" id="goToRegister" style="color: var(--neon-purple);">Зарегистрироваться</a>
            </p>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <h2 class="modal-title">Регистрация</h2>
            <div class="form-group">
                <label for="registerName">Имя пользователя</label>
                <input type="text" id="registerName" placeholder="Ваше имя">
            </div>
            <div class="form-group">
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" placeholder="Ваш email">
            </div>
            <div class="form-group">
                <label for="registerPassword">Пароль</label>
                <input type="password" id="registerPassword" placeholder="Придумайте пароль">
            </div>
            <button class="btn btn-primary" id="registerSubmit" style="width: 100%;">Зарегистрироваться</button>
            <p style="text-align: center; margin-top: 15px;">
                Уже есть аккаунт? <a href="#" id="goToLogin" style="color: var(--neon-purple);">Войти</a>
            </p>
        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content profile-modal">
            <h2 class="modal-title">Профиль пользователя</h2>
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">U</div>
                <div class="profile-info">
                    <h3 id="profileName">Пользователь</h3>
                    <p id="profileEmail">user@example.com</p>
                </div>
            </div>
            <div class="profile-stats">
                <div class="stat-card">
                    <div class="stat-value" id="statTracks">0</div>
                    <div class="stat-label">Треков</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPlaytime">0</div>
                    <div class="stat-label">Минут прослушано</div>
                </div>
            </div>
            <button class="btn" id="logoutBtn" style="width: 100%;">Выйти из аккаунта</button>
        </div>
    </div>

    <script>
        // База данных IndexedDB
        const DB_NAME = 'FlautPlayerDB';
        const DB_VERSION = 1;
        const USER_STORE = 'users';
        const PLAYLIST_STORE = 'playlists';
        let db = null;

        // Инициализация базы данных
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // Создаем хранилище для пользователей
                    if (!database.objectStoreNames.contains(USER_STORE)) {
                        const userStore = database.createObjectStore(USER_STORE, { keyPath: 'id', autoIncrement: true });
                        userStore.createIndex('email', 'email', { unique: true });
                    }
                    
                    // Создаем хранилище для плейлистов
                    if (!database.objectStoreNames.contains(PLAYLIST_STORE)) {
                        const playlistStore = database.createObjectStore(PLAYLIST_STORE, { keyPath: 'id', autoIncrement: true });
                        playlistStore.createIndex('userId', 'userId', { unique: false });
                    }
                };
            });
        }

        // Функции для работы с пользователями
        async function registerUser(userData) {
            const transaction = db.transaction([USER_STORE], 'readwrite');
            const store = transaction.objectStore(USER_STORE);
            
            return new Promise((resolve, reject) => {
                const request = store.add(userData);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getUserByEmail(email) {
            const transaction = db.transaction([USER_STORE], 'readonly');
            const store = transaction.objectStore(USER_STORE);
            const index = store.index('email');
            
            return new Promise((resolve, reject) => {
                const request = index.get(email);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getUserById(id) {
            const transaction = db.transaction([USER_STORE], 'readonly');
            const store = transaction.objectStore(USER_STORE);
            
            return new Promise((resolve, reject) => {
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Функции для работы с плейлистами
        async function savePlaylist(userId, playlist) {
            const transaction = db.transaction([PLAYLIST_STORE], 'readwrite');
            const store = transaction.objectStore(PLAYLIST_STORE);
            
            // Сначала удаляем старый плейлист пользователя
            const index = store.index('userId');
            const request = index.openCursor(IDBKeyRange.only(userId));
            
            request.onsuccess = () => {
                const cursor = request.result;
                if (cursor) {
                    cursor.delete();
                    cursor.continue();
                }
            };
            
            // Сохраняем новый плейлист
            return new Promise((resolve, reject) => {
                const saveRequest = store.add({ userId, playlist, updatedAt: new Date() });
                saveRequest.onsuccess = () => resolve(saveRequest.result);
                saveRequest.onerror = () => reject(saveRequest.error);
            });
        }

        async function getPlaylist(userId) {
            const transaction = db.transaction([PLAYLIST_STORE], 'readonly');
            const store = transaction.objectStore(PLAYLIST_STORE);
            const index = store.index('userId');
            
            return new Promise((resolve, reject) => {
                const request = index.get(userId);
                request.onsuccess = () => {
                    const result = request.result;
                    resolve(result ? result.playlist : []);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Создание звездного фона
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starsCount = 150;
            
            for (let i = 0; i < starsCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                const size = Math.random() * 3;
                const posX = Math.random() * 100;
                const posY = Math.random() * 100;
                const delay = Math.random() * 5;
                
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${posX}%`;
                star.style.top = `${posY}%`;
                star.style.animationDelay = `${delay}s`;
                
                starsContainer.appendChild(star);
            }
        }

        // Уведомления
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Элементы управления
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const progressBar = document.getElementById('progress');
        const progressContainer = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const volumeSlider = document.getElementById('volumeSlider');
        const playlistContainer = document.getElementById('playlist');
        const playlistEmpty = document.getElementById('playlistEmpty');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadedFiles = document.getElementById('uploadedFiles');
        const uploadBtn = document.getElementById('uploadBtn');
        const visualizer = document.getElementById('visualizer');
        const albumArt = document.getElementById('albumArt');
        const songTitle = document.getElementById('songTitle');
        const songArtist = document.getElementById('songArtist');

        // Модальные окна
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const profileModal = document.getElementById('profileModal');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const loginSubmit = document.getElementById('loginSubmit');
        const registerSubmit = document.getElementById('registerSubmit');
        const goToRegister = document.getElementById('goToRegister');
        const goToLogin = document.getElementById('goToLogin');
        const authButtons = document.getElementById('authButtons');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const statTracks = document.getElementById('statTracks');
        const statPlaytime = document.getElementById('statPlaytime');
        const logoutBtn = document.getElementById('logoutBtn');

        // Состояние плеера
        let isPlaying = false;
        let currentSongIndex = -1;
        let userPlaylist = [];
        let currentUser = null;
        let audioContext = null;
        let audioElement = null;
        let analyser = null;
        let source = null;
        let dataArray = null;
        let bufferLength = null;
        let animationId = null;
        let isShuffle = false;
        let isRepeat = false;
        let selectedFiles = [];

        // Инициализация
        document.addEventListener('DOMContentLoaded', async function() {
            createStars();
            await initDB();
            await loadUserData();
            updatePlaylistDisplay();
            setupEventListeners();
            
            if (currentUser) {
                await loadPlaylistFromStorage();
            }
        });

        // Настройка обработчиков событий
        function setupEventListeners() {
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', prevSong);
            nextBtn.addEventListener('click', nextSong);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);
            progressContainer.addEventListener('click', seek);
            volumeSlider.addEventListener('input', setVolume);
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleFileDrop);
            fileInput.addEventListener('change', handleFileSelect);
            uploadBtn.addEventListener('click', addFilesToPlaylist);
            
            loginBtn.addEventListener('click', () => showModal(loginModal));
            registerBtn.addEventListener('click', () => showModal(registerModal));
            userProfile.addEventListener('click', () => showModal(profileModal));
            loginSubmit.addEventListener('click', handleLogin);
            registerSubmit.addEventListener('click', handleRegister);
            goToRegister.addEventListener('click', () => {
                hideModal(loginModal);
                showModal(registerModal);
            });
            goToLogin.addEventListener('click', () => {
                hideModal(registerModal);
                showModal(loginModal);
            });
            logoutBtn.addEventListener('click', handleLogout);
            
            window.addEventListener('click', (e) => {
                if (e.target === loginModal) hideModal(loginModal);
                if (e.target === registerModal) hideModal(registerModal);
                if (e.target === profileModal) hideModal(profileModal);
            });
        }

        // Функции управления плеером
        function togglePlay() {
            if (userPlaylist.length === 0) return;
            
            if (!audioElement) {
                if (currentSongIndex === -1) {
                    currentSongIndex = 0;
                }
                loadSong(currentSongIndex);
            }
            
            if (isPlaying) {
                pauseSong();
            } else {
                playSong();
            }
        }

        function playSong() {
            if (!audioElement) return;
            
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            audioElement.play()
                .then(() => {
                    isPlaying = true;
                    playIcon.classList.remove('fa-play');
                    playIcon.classList.add('fa-pause');
                    startVisualizer();
                    updatePlaybackProgress();
                })
                .catch(error => {
                    console.error('Ошибка воспроизведения:', error);
                    showNotification('Ошибка воспроизведения трека');
                });
        }

        function pauseSong() {
            if (!audioElement) return;
            
            audioElement.pause();
            isPlaying = false;
            playIcon.classList.remove('fa-pause');
            playIcon.classList.add('fa-play');
            stopVisualizer();
        }

        function loadSong(index) {
            if (index < 0 || index >= userPlaylist.length) return;
            
            if (audioElement) {
                audioElement.pause();
                stopVisualizer();
            }
            
            currentSongIndex = index;
            const song = userPlaylist[index];
            
            audioElement = new Audio(song.url);
            audioElement.addEventListener('loadedmetadata', () => {
                totalTimeEl.textContent = formatTime(audioElement.duration);
            });
            audioElement.addEventListener('ended', handleSongEnd);
            
            audioElement.volume = volumeSlider.value / 100;
            
            songTitle.textContent = song.title || 'Неизвестный трек';
            songArtist.textContent = song.artist || 'Неизвестный исполнитель';
            
            if (song.cover) {
                albumArt.innerHTML = `<img src="${song.cover}" alt="Обложка">`;
            } else {
                albumArt.innerHTML = `<i class="fas fa-music"></i>`;
            }
            
            progressBar.style.width = '0%';
            currentTimeEl.textContent = '0:00';
            
            updateActivePlaylistItem();
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            initVisualizer();
            playSong();
        }

        function initVisualizer() {
            if (!audioContext) return;
            
            if (analyser) {
                analyser.disconnect();
            }
            
            analyser = audioContext.createAnalyser();
            source = audioContext.createMediaElementSource(audioElement);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            
            analyser.fftSize = 256;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
        }

        function startVisualizer() {
            if (!analyser) return;
            
            visualizer.style.display = 'flex';
            const bars = visualizer.querySelectorAll('.bar');
            
            function updateVisualizer() {
                if (!isPlaying) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                for (let i = 0; i < bars.length; i++) {
                    const value = dataArray[i * 4] / 255;
                    const height = Math.max(10, value * 50);
                    bars[i].style.height = `${height}px`;
                }
                
                animationId = requestAnimationFrame(updateVisualizer);
            }
            
            updateVisualizer();
        }

        function stopVisualizer() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            visualizer.style.display = 'none';
        }

        function updatePlaybackProgress() {
            if (!audioElement || !isPlaying) return;
            
            const updateProgress = () => {
                if (!audioElement) return;
                
                const currentTime = audioElement.currentTime;
                const duration = audioElement.duration;
                
                if (duration) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.style.width = `${progressPercent}%`;
                    currentTimeEl.textContent = formatTime(currentTime);
                }
                
                if (isPlaying) {
                    requestAnimationFrame(updateProgress);
                }
            };
            
            updateProgress();
        }

        function seek(e) {
            if (!audioElement || !audioElement.duration) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const seekTime = percent * audioElement.duration;
            
            audioElement.currentTime = seekTime;
            progressBar.style.width = `${percent * 100}%`;
            currentTimeEl.textContent = formatTime(seekTime);
        }

        function setVolume() {
            if (audioElement) {
                audioElement.volume = volumeSlider.value / 100;
            }
        }

        function nextSong() {
            if (userPlaylist.length === 0) return;
            
            let nextIndex;
            if (isShuffle) {
                nextIndex = Math.floor(Math.random() * userPlaylist.length);
            } else {
                nextIndex = (currentSongIndex + 1) % userPlaylist.length;
            }
            
            loadSong(nextIndex);
        }

        function prevSong() {
            if (userPlaylist.length === 0) return;
            
            let prevIndex;
            if (isShuffle) {
                prevIndex = Math.floor(Math.random() * userPlaylist.length);
            } else {
                prevIndex = (currentSongIndex - 1 + userPlaylist.length) % userPlaylist.length;
            }
            
            loadSong(prevIndex);
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleBtn.classList.toggle('active', isShuffle);
            showNotification(isShuffle ? 'Перемешивание включено' : 'Перемешивание выключено', 2000);
        }

        function toggleRepeat() {
            isRepeat = !isRepeat;
            repeatBtn.classList.toggle('active', isRepeat);
            showNotification(isRepeat ? 'Повтор включен' : 'Повтор выключен', 2000);
        }

        function handleSongEnd() {
            if (isRepeat) {
                audioElement.currentTime = 0;
                audioElement.play();
            } else {
                nextSong();
            }
        }

        // Функции для работы с плейлистом
        function updatePlaylistDisplay() {
            if (userPlaylist.length === 0) {
                playlistEmpty.style.display = 'block';
                playlistContainer.innerHTML = '';
                playlistContainer.appendChild(playlistEmpty);
            } else {
                playlistEmpty.style.display = 'none';
                playlistContainer.innerHTML = '';
                
                userPlaylist.forEach((song, index) => {
                    const playlistItem = document.createElement('div');
                    playlistItem.className = 'playlist-item';
                    if (index === currentSongIndex) {
                        playlistItem.classList.add('active');
                    }
                    
                    playlistItem.innerHTML = `
                        ${song.cover ? `<img src="${song.cover}" alt="Обложка">` : '<i class="fas fa-music" style="font-size: 24px; margin-right: 15px;"></i>'}
                        <div class="playlist-info">
                            <div class="playlist-song">${song.title || 'Неизвестный трек'}</div>
                            <div class="playlist-artist">${song.artist || 'Неизвестный исполнитель'}</div>
                        </div>
                        <div class="playlist-duration">${song.duration || '0:00'}</div>
                        <div class="playlist-actions">
                            <i class="fas fa-trash playlist-action" data-index="${index}"></i>
                        </div>
                    `;
                    
                    playlistItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('fa-trash')) {
                            loadSong(index);
                        }
                    });
                    
                    const deleteBtn = playlistItem.querySelector('.fa-trash');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeFromPlaylist(index);
                    });
                    
                    playlistContainer.appendChild(playlistItem);
                });
            }
        }

        function updateActivePlaylistItem() {
            const items = document.querySelectorAll('.playlist-item');
            items.forEach((item, index) => {
                if (index === currentSongIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        async function addToPlaylist(songData) {
            userPlaylist.push(songData);
            updatePlaylistDisplay();
            await savePlaylistToStorage();
            updateProfileStats();
            showNotification('Трек добавлен в плейлист');
        }

        async function removeFromPlaylist(index) {
            if (index === currentSongIndex) {
                if (audioElement) {
                    audioElement.pause();
                    stopVisualizer();
                    isPlaying = false;
                    playIcon.classList.remove('fa-pause');
                    playIcon.classList.add('fa-play');
                }
                currentSongIndex = -1;
            } else if (index < currentSongIndex) {
                currentSongIndex--;
            }
            
            userPlaylist.splice(index, 1);
            updatePlaylistDisplay();
            await savePlaylistToStorage();
            updateProfileStats();
            showNotification('Трек удален из плейлиста');
        }

        // Функции для работы с файлами
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.background = 'rgba(188, 19, 254, 0.2)';
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.background = 'rgba(188, 19, 254, 0.05)';
            
            const files = e.dataTransfer.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => file.type === 'audio/mpeg');
            
            if (selectedFiles.length === 0) {
                showNotification('Пожалуйста, выберите MP3 файлы');
                return;
            }
            
            uploadedFiles.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'uploaded-file';
                fileItem.innerHTML = `
                    <div class="uploaded-file-name">${file.name}</div>
                    <i class="fas fa-times file-remove" data-index="${index}"></i>
                `;
                
                const removeBtn = fileItem.querySelector('.file-remove');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedFiles.splice(index, 1);
                    fileItem.remove();
                });
                
                uploadedFiles.appendChild(fileItem);
            });
            
            showNotification(`Выбрано ${selectedFiles.length} файлов`);
        }

        function addFilesToPlaylist() {
            if (selectedFiles.length === 0) {
                showNotification('Пожалуйста, выберите файлы для загрузки');
                return;
            }
            
            if (!currentUser) {
                showNotification('Пожалуйста, войдите в аккаунт для загрузки музыки');
                return;
            }
            
            uploadBtn.innerHTML = '<div class="loading"></div> Обработка файлов...';
            uploadBtn.disabled = true;
            
            let processedFiles = 0;
            
            selectedFiles.forEach(file => {
                const url = URL.createObjectURL(file);
                
                extractMetadata(file, url)
                    .then(songData => {
                        addToPlaylist(songData);
                        processedFiles++;
                        
                        if (processedFiles === selectedFiles.length) {
                            uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Добавить в плейлист';
                            uploadBtn.disabled = false;
                            
                            selectedFiles = [];
                            uploadedFiles.innerHTML = '';
                            fileInput.value = '';
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка обработки файла:', error);
                        
                        const songData = {
                            title: file.name.replace('.mp3', ''),
                            artist: 'Неизвестный исполнитель',
                            url,
                            file: file.name
                        };
                        
                        addToPlaylist(songData);
                        processedFiles++;
                        
                        if (processedFiles === selectedFiles.length) {
                            uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Добавить в плейлист';
                            uploadBtn.disabled = false;
                            
                            selectedFiles = [];
                            uploadedFiles.innerHTML = '';
                            fileInput.value = '';
                        }
                    });
            });
        }

        // Функция для извлечения метаданных и обложки
        function extractMetadata(file, url) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const bytes = new Uint8Array(arrayBuffer);
                        
                        let title = file.name.replace('.mp3', '');
                        let artist = 'Неизвестный исполнитель';
                        let cover = null;
                        
                        let id3Position = findID3Position(bytes);
                        
                        if (id3Position !== -1) {
                            const id3Data = parseID3(bytes, id3Position);
                            title = id3Data.title || title;
                            artist = id3Data.artist || artist;
                            cover = id3Data.cover;
                        }
                        
                        resolve({
                            title,
                            artist,
                            cover,
                            url,
                            file: file.name
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Поиск позиции ID3 тега
        function findID3Position(bytes) {
            for (let i = 0; i < bytes.length - 2; i++) {
                if (bytes[i] === 0x49 && bytes[i+1] === 0x44 && bytes[i+2] === 0x33) {
                    return i;
                }
            }
            return -1;
        }

        // Парсинг ID3 тегов
        function parseID3(bytes, position) {
            const result = {
                title: null,
                artist: null,
                cover: null
            };
            
            try {
                let offset = position + 3;
                const version = bytes[offset];
                offset += 2;
                
                const size = (bytes[offset] << 21) | (bytes[offset+1] << 14) | 
                           (bytes[offset+2] << 7) | bytes[offset+3];
                offset += 4;
                
                const endPosition = position + 10 + size;
                
                while (offset < endPosition - 10) {
                    if (bytes[offset] === 0) break;
                    
                    const frameID = String.fromCharCode(
                        bytes[offset], bytes[offset+1], bytes[offset+2], bytes[offset+3]
                    );
                    
                    const frameSize = (bytes[offset+4] << 24) | (bytes[offset+5] << 16) | 
                                   (bytes[offset+6] << 8) | bytes[offset+7];
                    
                    offset += 10;
                    
                    if (frameSize <= 0 || offset + frameSize > bytes.length) {
                        break;
                    }
                    
                    if (frameID === 'TIT2') {
                        result.title = parseTextFrame(bytes, offset, frameSize);
                    } else if (frameID === 'TPE1') {
                        result.artist = parseTextFrame(bytes, offset, frameSize);
                    } else if (frameID === 'APIC') {
                        result.cover = parsePictureFrame(bytes, offset, frameSize);
                    }
                    
                    offset += frameSize;
                }
            } catch (error) {
                console.error('Ошибка парсинга ID3:', error);
            }
            
            return result;
        }

        // Парсинг текстовых фреймов
        function parseTextFrame(bytes, offset, size) {
            try {
                const encoding = bytes[offset];
                offset++;
                
                let text = '';
                for (let i = 0; i < size - 1; i++) {
                    const charCode = bytes[offset + i];
                    if (charCode === 0) break;
                    text += String.fromCharCode(charCode);
                }
                
                return text.trim() || null;
            } catch (error) {
                return null;
            }
        }

        // Парсинг фрейма с изображением
        function parsePictureFrame(bytes, offset, size) {
            try {
                const encoding = bytes[offset];
                offset++;
                
                while (offset < bytes.length && bytes[offset] !== 0) {
                    offset++;
                }
                offset++;
                
                offset++;
                
                while (offset < bytes.length && bytes[offset] !== 0) {
                    offset++;
                }
                offset++;
                
                const imageData = bytes.subarray(offset, offset + (size - (offset - (offset - size))));
                
                if (imageData.length > 0) {
                    let mimeType = 'image/jpeg';
                    
                    if (imageData[0] === 0x89 && imageData[1] === 0x50 && 
                        imageData[2] === 0x4E && imageData[3] === 0x47) {
                        mimeType = 'image/png';
                    } else if (imageData[0] === 0xFF && imageData[1] === 0xD8) {
                        mimeType = 'image/jpeg';
                    }
                    
                    const blob = new Blob([imageData], { type: mimeType });
                    return URL.createObjectURL(blob);
                }
            } catch (error) {
                console.error('Ошибка парсинга изображения:', error);
            }
            
            return null;
        }

        // Функции для работы с пользователем
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Пожалуйста, заполните все поля');
                return;
            }
            
            try {
                const user = await getUserByEmail(email);
                
                if (!user) {
                    showNotification('Пользователь не найден');
                    return;
                }
                
                if (user.password !== password) {
                    showNotification('Неверный пароль');
                    return;
                }
                
                currentUser = user;
                await saveUserData();
                updateUIForUser();
                hideModal(loginModal);
                await loadPlaylistFromStorage();
                showNotification(`Добро пожаловать, ${user.name}!`);
            } catch (error) {
                console.error('Ошибка входа:', error);
                showNotification('Ошибка входа в систему');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                showNotification('Пожалуйста, заполните все поля');
                return;
            }
            
            try {
                const existingUser = await getUserByEmail(email);
                if (existingUser) {
                    showNotification('Пользователь с таким email уже существует');
                    return;
                }
                
                const userData = {
                    name: name,
                    email: email,
                    password: password,
                    avatar: name.charAt(0).toUpperCase(),
                    createdAt: new Date()
                };
                
                const userId = await registerUser(userData);
                userData.id = userId;
                currentUser = userData;
                
                await saveUserData();
                updateUIForUser();
                hideModal(registerModal);
                userPlaylist = [];
                await savePlaylistToStorage();
                updatePlaylistDisplay();
                showNotification(`Аккаунт создан! Добро пожаловать, ${name}!`);
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                showNotification('Ошибка создания аккаунта');
            }
        }

        async function handleLogout() {
            if (audioElement) {
                audioElement.pause();
                stopVisualizer();
                isPlaying = false;
                playIcon.classList.remove('fa-pause');
                playIcon.classList.add('fa-play');
            }
            
            currentUser = null;
            userPlaylist = [];
            await saveUserData();
            updateUIForUser();
            hideModal(profileModal);
            
            songTitle.textContent = 'Выберите трек';
            songArtist.textContent = 'Ваш плейлист';
            albumArt.innerHTML = '<i class="fas fa-music"></i>';
            progressBar.style.width = '0%';
            currentTimeEl.textContent = '0:00';
            totalTimeEl.textContent = '0:00';
            updatePlaylistDisplay();
            
            showNotification('Вы вышли из аккаунта');
        }

        function updateUIForUser() {
            if (currentUser) {
                authButtons.style.display = 'none';
                userProfile.style.display = 'flex';
                userAvatar.textContent = currentUser.avatar;
                userName.textContent = currentUser.name;
                
                profileAvatar.textContent = currentUser.avatar;
                profileName.textContent = currentUser.name;
                profileEmail.textContent = currentUser.email;
                updateProfileStats();
            } else {
                authButtons.style.display = 'flex';
                userProfile.style.display = 'none';
            }
        }

        function updateProfileStats() {
            statTracks.textContent = userPlaylist.length;
            const totalMinutes = userPlaylist.length * 3;
            statPlaytime.textContent = totalMinutes;
        }

        // Функции для работы с локальным хранилищем
        async function saveUserData() {
            if (currentUser) {
                localStorage.setItem('flautPlayer_currentUser', JSON.stringify(currentUser));
            } else {
                localStorage.removeItem('flautPlayer_currentUser');
            }
        }

        async function loadUserData() {
            const userData = localStorage.getItem('flautPlayer_currentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                updateUIForUser();
            }
        }

        async function savePlaylistToStorage() {
            if (currentUser && db) {
                try {
                    await savePlaylist(currentUser.id, userPlaylist);
                } catch (error) {
                    console.error('Ошибка сохранения плейлиста:', error);
                }
            }
        }

        async function loadPlaylistFromStorage() {
            if (currentUser && db) {
                try {
                    userPlaylist = await getPlaylist(currentUser.id);
                    updatePlaylistDisplay();
                } catch (error) {
                    console.error('Ошибка загрузки плейлиста:', error);
                    userPlaylist = [];
                updatePlaylistDisplay();
                }
            }
        }

        // Вспомогательные функции
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function showModal(modal) {
            modal.style.display = 'flex';
        }

        function hideModal(modal) {
            modal.style.display = 'none';
        }

        // Регистрация Service Worker для PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
